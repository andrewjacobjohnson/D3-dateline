<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>D3 Dateline</title>
	<script src="lib/d3.v3.min.js" charset="utf-8"></script>
    <style type="text/css">
          .chart {
		    font-family: Arial, sans-serif;
		    font-size: 10px;
		    border: 1px solid black;
		    width: 600px;
		  }
		  .axis path, .axis line {
		    fill: none;
		    stroke: #000;
		    shape-rendering: crispEdges;
		  }
		  .letter {
		  	fill: #ffffd0;
	    	stroke: #000000;
	    	stroke-width: 2
		  }
		  .link {
		  	fill:none; 
		  	stroke:grey; 
		  	stroke-width:1 
		  }
		  .arrowhead {
		  	stroke: grey;
		  	fill: grey;
		  	stroke-width:1 
		  }
		  .bar {
		    fill: steelblue;
		  }
		  .fromR {
		  	fill: green;
		  }
		  .fromF {
		    fill: white;
		  }
     </style>

	<script type="text/javascript">
	window.onload = function(){
  	var width = 600,
    	height = 200,
		margin = {top: 40, right: 40, bottom: 40, left:40},
		radius = 10;

	// ctlx and ctly are the offsets for the control points for the Bezier curve.
	//   ctly is subtracted from source and target, to place control point
	//      above the source/target
	//   ctlx is added to source and subtracted from target, to place control point
	//      so as to flatten the curve slightly
	var ctlx = 10;
	var ctly = 35;

      
	var svg = d3.select("#svgContent")
                  .append("svg")
                  .attr("width", width)
                  .attr("height", height)
                  .attr('preserveAspectRatio', 'xMinYMin slice') 
                  .append('g');

svg.append("svg:defs").selectAll("marker")
    .data(["end"])
  .enter().append("svg:marker")    
    .attr("id", String)
    .attr("class", "arrowhead")
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 25)
    .attr("refY", -1.5)
    .attr("markerWidth", 8)
    .attr("markerHeight", 8)
    .attr("orient", "auto")
  .append("svg:path")
    .attr("d", "M0,-5L10,0L0,5");
    
	var dataSet = {
		nodes: [
         {"name": "Letter 1","date":"2012-03-20","id":1,"from":"R"},
         {"name": "Letter 2","date":"2012-03-23","id":2,"from":"F"},
         {"name": "Letter 3","date":"2012-03-22","id":3,"from":"R"},
         {"name": "Letter 4","date":"2012-03-23","id":4,"from":"R"},
         {"name": "Letter 5","date":"2012-03-23","id":5,"from":"R"},
         {"name": "Letter 6","date":"2012-03-25","id":6,"from":"F"},
         {"name": "Letter 7","date":"2012-03-26","id":7,"from":"F"}
      ],
      
      links: [
         {"source":1, "target":3, "type": "answeredby"},
         {"source":0, "target":6, "type": "answeredby"},
         {"source":6, "target":4, "type": "answeredby"},
         {"source":2, "target":5, "type": "answeredby"}
      ]
			
		};
		
		
		var line = d3.svg.line()

      var x = d3.time.scale()
      .domain([new Date(dataSet.nodes[0].date), d3.time.day.offset(new Date(dataSet.nodes[dataSet.nodes.length - 1].date), 1)])
      .rangeRound([0, width - margin.left - margin.right]);
      
      var xAxis = d3.svg.axis()
      .scale(x)
      .orient('bottom')
      .ticks(d3.time.days, 1)
      .tickFormat(d3.time.format('%a %d'))
      .tickSize(5)
      .tickPadding(8);

     svg.append('g')
      .attr('class', 'x axis')
      .attr('transform', 'translate(0, ' + (height - margin.top - margin.bottom) + ')')
      .call(xAxis);

		// add fixed coords to nodes
		var stackcounts = [];

		 dataSet.nodes.forEach(function(node) {
		 // x is always over the sortdate
		 // y is stacked on any letters already on that date if the date is precise,
		 //   otherwise at top of graph to allow it to be pulled into position
			node.x = x(new Date(node.date)) +20; 
    	 	if (node.id != 7) {
		    	var previousLetters = (stackcounts['d'+node.date]) ? stackcounts['d'+node.date] : 0;
        	 	stackcounts['d'+node.date] = previousLetters+1;
         		node.y = height-100-(previousLetters*radius*2)-previousLetters; 
	         	node.fixed = true;
         	}
         	else {
         		node.y = 0;
         	}
		});

		var force = self.force = d3.layout.force()
			.nodes(dataSet.nodes)
			.links(dataSet.links)
			.gravity(0.05)
            .distance(50)
            .charge(-50)
			.size([width,height])
			.start();

		function curve(d) {
			// Bezier curve
			// we assume source is earlier than target or on same day
			var c, upper, lower;
			if (d.source.x == d.target.x) {
				// same day - control points on right - need to start with upper
				if (d.source.y < d.target.y) {
					upper = d.source;
					lower = d.target;
				}
				else {
					upper = d.target;
					lower = d.source;
				}
				c = "M" + upper.x + "," + upper.y +
					" C" + (upper.x + ctly) + "," + (upper.y - ctlx) +
					" " + (lower.x + ctly) + "," + (lower.y + ctlx) +
					" " + lower.x + "," + lower.y;
			}
			else {
				// different days - use ellipse
				var dx = d.target.x - d.source.x,
                	dy = d.target.y - d.source.y,
                	dr = Math.sqrt(dx * dx + dy * dy);
            	c = "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
			}
				return c;
		}

		var link = svg.selectAll(".link")
				.data(dataSet.links)
			.enter().append("svg:path")
			.attr("d", function(d) {
				return curve(d);
			})
			.attr("class", "link")
			.attr("marker-end", "url(#end)");

       var node = svg.selectAll("circle")
			.data(dataSet.nodes)
		.enter().append("svg:circle")
			.attr('id', function(d) {return "n" + d.id; })
			.attr('class', function(d) { return "letter d" + d.date + " from" + d.from; })
			.attr('r', radius);
         node.append("svg:title")
			.text(function(d) { return d.name; });

  
		force.on("tick", tick);

		function tick() {
			link.attr("d", function(d) {
				return curve(d);
            });			
            node.attr("cx", function(d) { return d.x; })
				.attr("cy", function(d) { return d.y; });
			}
		};
</script>
</head>
<body>

	<div id="svgContent" class="chart"></div>
  
</body>
</html>
